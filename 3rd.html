<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>نظام حضور ثالثة ابتدائي</title>
<style>
body { font-family: "Cairo", sans-serif; margin:0; background:#f5f6fa; color:#222; }
header { display:flex; justify-content:space-around; align-items:center; background:#0078d7; color:white; padding:15px; font-weight:bold; }
header button { background:transparent; border:none; color:white; font-size:16px; cursor:pointer; transition:0.3s; }
header button.active { border-bottom:3px solid #fff; }
main { padding:20px; }
.section { display:none; }
.section.active { display:block; }
.card { background:white; border-radius:15px; box-shadow:0 4px 10px rgba(0,0,0,0.1); padding:20px; margin-bottom:20px; position:relative; }
label { display:block; margin-bottom:6px; font-weight:bold; }
select, input[type="text"], input[type="number"] { width:100%; padding:10px; margin-bottom:15px; border:1px solid #ccc; border-radius:10px; font-size:15px; }
.radio-group { display:flex; gap:15px; margin-bottom:15px; }
.radio-group label { font-weight:normal; }
button.submit-btn { background:#0078d7; color:white; border:none; border-radius:10px; padding:10px 20px; cursor:pointer; font-size:16px; transition:0.3s; }
button.submit-btn:disabled { background:#aaa; cursor:not-allowed; }
.suggestions { position:absolute; background:white; border:1px solid #ccc; border-radius:8px; width:calc(100% - 40px); max-height:150px; overflow-y:auto; box-shadow:0 4px 8px rgba(0,0,0,0.15); z-index:10; }
.suggestions div { padding:8px; cursor:pointer; transition:0.2s; }
.suggestions div:hover { background:#0078d7; color:white; }
table { border-collapse: collapse; width: 100%; margin-top: 10px; }
table, th, td { border: 1px solid #ccc; }
th, td { padding: 8px; text-align: center; }
th { background: #0078d7; color: white; }
@media (max-width:600px) { .card { padding:15px; } }
</style>
</head>
<body>
<header>
<button id="attendanceTab" class="active">📋 التسجيل</button>
<button id="reportsTab">📊 التقارير</button>
</header>

<main>
<section id="attendanceSection" class="section active">
  <!-- تسجيل الحضور -->
  <div class="card">
    <h3>تسجيل الحضور والنوتة</h3>
    <label>السنة</label><select id="yearSelect"></select>
    <label>الشهر</label><select id="monthSelect"></select>
    <label>التاريخ</label><select id="dateSelect"></select>
    <label>الاسم</label>
    <input type="text" id="nameInput" placeholder="اكتب الاسم...(لازم من الاقتراحات)">
    <div id="nameSuggestions" class="suggestions" style="display:none;"></div>
    <label>الحضور</label>
    <div class="radio-group">
      <label><input type="radio" name="attendance" value="حضر"> حضر</label>
      <label><input type="radio" name="attendance" value="غاب"> غاب</label>
    </div>
    <label>جاب النوتة؟</label>
    <div class="radio-group">
      <label><input type="radio" name="notebook" value="نعم"> نعم</label>
      <label><input type="radio" name="notebook" value="لا"> لا</label>
    </div>
    <button id="attendanceSubmit" class="submit-btn" disabled>إرسال</button>
  </div>

  <!-- تسجيل التفاعل -->
  <div class="card">
    <h3>تسجيل التفاعل</h3>
    <label>الاسم</label>
    <input type="text" id="interactionName" placeholder="اكتب الاسم...">
    <div id="interactionSuggestions" class="suggestions" style="display:none;"></div>
    <label>نقاط التفاعل (0 - 5)</label>
    <input type="number" id="interactionPoints" min="0" max="5">
    <button id="interactionSubmit" class="submit-btn" disabled>إرسال</button>
  </div>
</section>

<section id="reportsSection" class="section">
  <!-- أعياد الميلاد -->
  <div class="card">
    <h3>أعياد ميلاد الأطفال</h3>
    <label>اختر الشهر</label><select id="birthdayMonth"></select>
    <button id="birthdayShow" class="submit-btn">عرض الأسماء</button>
    <div id="birthdayResult"></div>
  </div>

  <!-- تقرير الحضور -->
  <div class="card">
    <h3>تقرير الحضور</h3>
    <label>السنة</label><select id="reportYear"></select>
    <label>الشهر</label><select id="reportMonth"></select>
    <label>التاريخ</label><select id="reportDate"></select>
    <button id="showCount" class="submit-btn">عدد الحضور</button>
    <button id="showNames" class="submit-btn">عرض الأسماء</button>
    <div id="attendanceReportResult"></div>
  </div>

  <!-- بيانات الطفل -->
  <div class="card">
    <h3>بيانات الطفل</h3>
    <label>الاسم</label><input type="text" id="childInfoName" placeholder="اكتب الاسم...">
    <div id="childInfoSuggestions" class="suggestions" style="display:none;"></div>
    <button id="showChildInfo" class="submit-btn">عرض البيانات</button>
    <div id="childInfoResult"></div>
  </div>

  <!-- حضور الطفل في الشهر -->
  <div class="card">
    <h3>حضور الطفل في الشهر</h3>
    <label>الاسم</label><input type="text" id="childAttendanceName" placeholder="اكتب الاسم...">
    <div id="childAttendanceSuggestions" class="suggestions" style="display:none;"></div>
    <label>السنة</label><select id="childAttendanceYear"></select>
    <label>الشهر</label><select id="childAttendanceMonth"></select>
    <button id="showChildAttendance" class="submit-btn">عرض الحضور</button>
    <div id="childAttendanceResult"></div>
  </div>

  <!-- نقاط التفاعل الشهرية -->
  <div class="card">
    <h3>نقاط التفاعل الشهرية</h3>
    <label>الاسم</label><input type="text" id="interactionReportName" placeholder="اكتب الاسم...">
    <div id="interactionReportSuggestions" class="suggestions" style="display:none;"></div>
    <label>السنة</label><select id="interactionReportYear"></select>
    <label>الشهر</label><select id="interactionReportMonth"></select>
    <button id="showInteractionReport" class="submit-btn">عرض نقاط التفاعل</button>
    <div id="interactionReportResult"></div>
  </div>
</section>
</main>

<script>
const apiURL="https://3rd.johnmamdouh777.workers.dev/";
const currentYear = new Date().getFullYear();
const months=["يناير","فبراير","مارس","أبريل","مايو","يونيو","يوليو","أغسطس","سبتمبر","أكتوبر","نوفمبر","ديسمبر"];

// --- التنقل بين الأقسام ---
document.getElementById("attendanceTab").onclick = () => {
  document.getElementById("attendanceTab").classList.add("active");
  document.getElementById("reportsTab").classList.remove("active");
  document.getElementById("attendanceSection").classList.add("active");
  document.getElementById("reportsSection").classList.remove("active");
};
document.getElementById("reportsTab").onclick = () => {
  document.getElementById("reportsTab").classList.add("active");
  document.getElementById("attendanceTab").classList.remove("active");
  document.getElementById("reportsSection").classList.add("active");
  document.getElementById("attendanceSection").classList.remove("active");
};

// --- تعبئة السنوات والشهور ---
function fillYearSelect(sel){
  for(let y=currentYear-1;y<=currentYear+1;y++){
    const opt=document.createElement("option");
    opt.value=y; opt.textContent=y;
    sel.appendChild(opt);
  }
}
fillYearSelect(document.getElementById("yearSelect"));
fillYearSelect(document.getElementById("reportYear"));
fillYearSelect(document.getElementById("childAttendanceYear"));
fillYearSelect(document.getElementById("interactionReportYear"));

function fillMonthSelect(sel){
  if (!sel) return; // حماية إذا العنصر مش موجود
  months.forEach((m,i)=>{
    const opt=document.createElement("option");
    opt.value=i+1; opt.textContent=m;
    sel.appendChild(opt);
  });
}

fillMonthSelect(document.getElementById("monthSelect"));
fillMonthSelect(document.getElementById("reportMonth"));
fillMonthSelect(document.getElementById("childAttendanceMonth"));
fillMonthSelect(document.getElementById("interactionReportMonth"));
fillMonthSelect(document.getElementById("birthdayMonth"));

// --- تعبئة أيام الجمعة ---
function fillFridays(yearSel, monthSel, dateSel){
  dateSel.innerHTML="";
  const year=+yearSel.value;
  const month=+monthSel.value-1;
  const daysInMonth=new Date(year,month+1,0).getDate();
  for(let d=1; d<=daysInMonth; d++){
    const date=new Date(year,month,d);
    if(date.getDay()===5){
      const opt=document.createElement("option");
      opt.value=d; opt.textContent=`${d}/${month+1}/${year}`;
      dateSel.appendChild(opt);
    }
  }
}
fillFridays(document.getElementById("yearSelect"), document.getElementById("monthSelect"), document.getElementById("dateSelect"));
document.getElementById("yearSelect").onchange = () => fillFridays(document.getElementById("yearSelect"), document.getElementById("monthSelect"), document.getElementById("dateSelect"));
document.getElementById("monthSelect").onchange = () => fillFridays(document.getElementById("yearSelect"), document.getElementById("monthSelect"), document.getElementById("dateSelect"));

// --- تحميل الأسماء ---
let allNames = [];

async function loadNames(){
  try{
    const res = await fetch(apiURL+"?type=names");
    const data = await res.json();
    allNames = Array.isArray(data) ? data : (data.names || []);
  } catch(err){ 
    console.warn(err); 
  }
}

const nameInput = document.getElementById("nameInput");
const interactionName = document.getElementById("interactionName");
const childInfoName = document.getElementById("childInfoName");
const childAttendanceName = document.getElementById("childAttendanceName");
const interactionReportName = document.getElementById("interactionReportName");

// اختر مكان تنفيذ التحميل فقط مرة:
async function initAttendance(){
  await loadNames(); // ننتظر تحميل الأسماء
  // بعد تحميل الأسماء نربط الاقتراحات
  setupSuggestions(nameInput, document.getElementById("nameSuggestions"));
  setupSuggestions(interactionName, document.getElementById("interactionSuggestions"));
  setupSuggestions(childInfoName, document.getElementById("childInfoSuggestions"));
  setupSuggestions(childAttendanceName, document.getElementById("childAttendanceSuggestions"));
  setupSuggestions(interactionReportName, document.getElementById("interactionReportSuggestions"));
  checkAttendanceReady();
}
initAttendance();

// --- الاقتراحات ---
function setupSuggestions(inputEl,suggestionsEl){
  inputEl.addEventListener("input",()=>{
    const q=inputEl.value.trim();
    if(!q) return suggestionsEl.style.display="none";
    const filtered=allNames.filter(n=>n.includes(q)).slice(0,10);
    if(filtered.length===0){ suggestionsEl.style.display="none"; return; }
    suggestionsEl.innerHTML="";
    filtered.forEach(name=>{
      const div=document.createElement("div");
      div.textContent=name;
      div.onclick = ()=>{ inputEl.value=name; suggestionsEl.style.display="none"; inputEl.dispatchEvent(new Event("input")); };
      suggestionsEl.appendChild(div);
    });
    suggestionsEl.style.display="block";
  });
  document.addEventListener("click",(e)=>{
    if(!inputEl.contains(e.target)&&!suggestionsEl.contains(e.target)) suggestionsEl.style.display="none";
  });
}
setupSuggestions(document.getElementById("nameInput"),document.getElementById("nameSuggestions"));
setupSuggestions(document.getElementById("interactionName"),document.getElementById("interactionSuggestions"));
setupSuggestions(document.getElementById("childInfoName"),document.getElementById("childInfoSuggestions"));
setupSuggestions(document.getElementById("childAttendanceName"),document.getElementById("childAttendanceSuggestions"));
setupSuggestions(document.getElementById("interactionReportName"),document.getElementById("interactionReportSuggestions"));

// --- تفعيل زر الحضور ---
const attendanceRadios = document.querySelectorAll('input[name="attendance"]');
const notebookRadios = document.querySelectorAll('input[name="notebook"]');
const attendanceSubmit = document.getElementById("attendanceSubmit");

function checkAttendanceReady(){
  const validName = allNames.includes(nameInput.value.trim());
  const attendanceChecked = Array.from(attendanceRadios).some(r=>r.checked);
  const notebookChecked = Array.from(notebookRadios).some(r=>r.checked);
  attendanceSubmit.disabled = !(validName && attendanceChecked && notebookChecked);
}
nameInput.addEventListener("input", checkAttendanceReady);
attendanceRadios.forEach(r=>r.addEventListener("change", checkAttendanceReady));
notebookRadios.forEach(r=>r.addEventListener("change", checkAttendanceReady));
checkAttendanceReady();

// --- إرسال الحضور ---
attendanceSubmit.addEventListener("click", async ()=>{
  const name=nameInput.value.trim();
  const attendance=document.querySelector('input[name="attendance"]:checked').value;
  const notebook=document.querySelector('input[name="notebook"]:checked').value;
  const year=document.getElementById("yearSelect").value;
  const month=document.getElementById("monthSelect").value;
  const date=document.getElementById("dateSelect").value;

  // --- تحقق مسبق للتأكد من عدم تكرار الحضور ---
try {
  const checkRes = await fetch(`${apiURL}?type=checkAttendance&name=${encodeURIComponent(name)}&year=${year}&month=${month}&date=${encodeURIComponent(date)}`);
  const checkData = await checkRes.json();
  if(checkData.exists) {
    alert(`❌ لا يمكن تسجيل الحضور مرة ثانية: ${name}`);
    return; // توقف التنفيذ هنا
  }
} catch {
  alert("⚠️ لم يتم الاتصال بالخادم للتحقق من الحضور.");
  return;
}

  attendanceSubmit.disabled=true;
  const data={ type:"attendance", year, month, date, name, attendance, notebook };
  try{
    const res=await fetch(apiURL, { method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify(data) });
    const result=await res.json();
    if(result.success){
      alert("✅ تم تسجيل الحضور بنجاح!");
      nameInput.value="";
      attendanceRadios.forEach(r=>r.checked=false);
      notebookRadios.forEach(r=>r.checked=false);
      checkAttendanceReady();
    }else alert("❌ حدث خطأ أثناء التسجيل.");
  }catch{ alert("⚠️ لم يتم الاتصال بالخادم."); }
  finally{ attendanceSubmit.disabled=false; }
});

// --- تفعيل زر التفاعل ---
const interactionName=document.getElementById("interactionName");
const interactionPoints=document.getElementById("interactionPoints");
const interactionSubmit=document.getElementById("interactionSubmit");

function checkInteractionReady(){
  const name=interactionName.value.trim();
  const points=Number(interactionPoints.value);
  const validName=allNames.includes(name);
  const validPoints=!isNaN(points) && points>=0 && points<=5;
  interactionSubmit.disabled=!(name && validPoints && validName);
}
interactionName.addEventListener("input", checkInteractionReady);
interactionPoints.addEventListener("input", checkInteractionReady);
checkInteractionReady();

// --- إرسال التفاعل ---
interactionSubmit.addEventListener("click", async ()=>{
  const name=interactionName.value.trim();
  const points=Number(interactionPoints.value);
  if(points<0 || points>5){ alert("❌ النقاط يجب أن تكون بين 0 و 5."); return; }

  try{
    const checkRes=await fetch(`${apiURL}?type=checkInteraction&name=${encodeURIComponent(name)}`);
    const checkData=await checkRes.json();
    if(checkData.exists){ alert(`❌ لا يمكن إضافة التفاعل مرة ثانية في هذا الأسبوع لـ ${name}.`); return; }
  }catch{ alert("⚠️ لم يتم الاتصال بالخادم للتحقق من التفاعل."); return; }

  interactionSubmit.disabled=true;
  const data={ type:"interaction", name, points };
  try{
    const res=await fetch(apiURL, { method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify(data) });
    const result=await res.json();
    if(result.success){
      alert("✅ تم تسجيل التفاعل بنجاح!");
      interactionName.value="";
      interactionPoints.value="";
      checkInteractionReady();
    }else alert("❌ حدث خطأ أثناء التسجيل.");
  }catch{ alert("⚠️ لم يتم الاتصال بالخادم."); }
  finally{ interactionSubmit.disabled=false; }
});

// --- دوال عرض الجداول ---
function renderListAsTable(container, arr, colName="الاسم"){
  if(!arr || arr.length===0){ container.innerHTML="لا توجد بيانات"; return; }
  container.innerHTML = `<table><tr><th>${colName}</th></tr>` + arr.map(x=>`<tr><td>${x}</td></tr>`).join("") + "</table>";
}
function renderObjectAsTable(container, obj){
  if(!obj || Object.keys(obj).length===0){ container.innerHTML="لا توجد بيانات"; return; }
  container.innerHTML = `<table>` + Object.entries(obj).map(([k,v])=>`<tr><th>${k}</th><td>${v}</td></tr>`).join("") + `</table>`;
}
function renderArrayOfObjectsAsTable(container, arr, headers){
  if(!arr || arr.length===0){ container.innerHTML="لا توجد بيانات"; return; }
  container.innerHTML = `<table><tr>${headers.map(h=>`<th>${h}</th>`).join("")}</tr>` +
    arr.map(row=>`<tr>${headers.map(h=>`<td>${row[h]||""}</td>`).join("")}</tr>`).join("") + `</table>`;
}
  // --- أعياد الميلاد ---
document.getElementById("birthdayShow").addEventListener("click", async () => {
  const month = document.getElementById("birthdayMonth").value;
  const container = document.getElementById("birthdayResult");
  container.innerHTML = "جاري التحميل...";
  try {
    const res = await fetch(`${apiURL}?type=birthdays&month=${month}`);
    const data = await res.json();
    renderListAsTable(container, data.names || [], "اسم الطفل");
  } catch (err) {
    console.error(err);
    container.innerHTML = "❌ لم يتم الاتصال بالخادم.";
  }
});

// --- تقرير الحضور ---
document.getElementById("showCount").addEventListener("click", async () => {
  const year = document.getElementById("reportYear").value;
  const month = document.getElementById("reportMonth").value;
  const date = document.getElementById("reportDate").value;
  const container = document.getElementById("attendanceReportResult");
  container.innerHTML = "جاري التحميل...";
  try {
    const res = await fetch(`${apiURL}?type=attendanceCount&year=${year}&month=${month}&date=${date}`);
    const data = await res.json();
    container.innerHTML = `عدد الحضور: ${data.count || 0}`;
  } catch {
    container.innerHTML = "❌ لم يتم الاتصال بالخادم.";
  }
});

document.getElementById("showNames").addEventListener("click", async () => {
  const year = document.getElementById("reportYear").value;
  const month = document.getElementById("reportMonth").value;
  const date = document.getElementById("reportDate").value;
  const container = document.getElementById("attendanceReportResult");
  container.innerHTML = "جاري التحميل...";
  try {
    const res = await fetch(`${apiURL}?type=attendanceNames&year=${year}&month=${month}&date=${date}`);
    const data = await res.json();
    renderListAsTable(container, data.names || [], "اسم الطفل");
  } catch {
    container.innerHTML = "❌ لم يتم الاتصال بالخادم.";
  }
});

// --- بيانات الطفل ---
document.getElementById("showChildInfo").addEventListener("click", async () => {
  const name = document.getElementById("childInfoName").value.trim();
  const container = document.getElementById("childInfoResult");
  if(!name) return alert("ادخل اسم الطفل");
  container.innerHTML = "جاري التحميل...";
  try {
    const res = await fetch(`${apiURL}?type=childInfo&name=${encodeURIComponent(name)}`);
    const data = await res.json();
    renderObjectAsTable(container, data);
  } catch {
    container.innerHTML = "❌ لم يتم الاتصال بالخادم.";
  }
});

// --- حضور الطفل في الشهر ---
document.getElementById("showChildAttendance").addEventListener("click", async () => {
  const name = document.getElementById("childAttendanceName").value.trim();
  const year = document.getElementById("childAttendanceYear").value;
  const month = document.getElementById("childAttendanceMonth").value;
  const container = document.getElementById("childAttendanceResult");
  if(!name) return alert("ادخل اسم الطفل");
  container.innerHTML = "جاري التحميل...";
  try {
    const res = await fetch(`${apiURL}?type=childAttendance&name=${encodeURIComponent(name)}&year=${year}&month=${month}`);
    const data = await res.json();
    renderArrayOfObjectsAsTable(container, data.records || [], ["التاريخ", "الحضور", "جاب النوتة"]);
  } catch {
    container.innerHTML = "❌ لم يتم الاتصال بالخادم.";
  }
});

// --- نقاط التفاعل الشهرية ---
document.getElementById("showInteractionReport").addEventListener("click", async () => {
  const name = document.getElementById("interactionReportName").value.trim();
  const year = document.getElementById("interactionReportYear").value;
  const month = document.getElementById("interactionReportMonth").value;
  const container = document.getElementById("interactionReportResult");
  if(!name) return alert("ادخل اسم الطفل");
  container.innerHTML = "جاري التحميل...";
  try {
    const res = await fetch(`${apiURL}?type=interactionReport&name=${encodeURIComponent(name)}&year=${year}&month=${month}`);
    const data = await res.json();
    renderArrayOfObjectsAsTable(container, data.records || [], ["التاريخ", "نقاط التفاعل"]);
  } catch {
    container.innerHTML = "❌ لم يتم الاتصال بالخادم.";
  }
});
</script>
</body>
</html>
